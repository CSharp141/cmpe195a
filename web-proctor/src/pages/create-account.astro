---
import Layout from "../layouts/Layout.astro";
import { isUnique } from "../utils/new-user";
import { db, User } from 'astro:db';


let loginError = '';

if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        const username = data.get("username");
        const password = data.get("password");
        
        if (typeof username === 'string' && typeof password === 'string') {
            const isValid = await isUnique(username);
            if (isValid) {
                await db.insert(User).values({ username, password });
            } else {
                loginError = "Username already taken";
            }
        }

    } catch (error) {
        if (error instanceof Error) {
            console.error(error.message);
        }
    }
}
---

<Layout title="Create Account">
    <main>
        <form method="POST">
            <label>
                Username:
                <input type="text" name="username" required />
            </label>
            <label>
                Password:
                <input type="password" name="password" required minlength="5" />
            </label>
            <button>Submit</button>
            {loginError && <p style="color: red;">{loginError}</p>}
        </form>
    </main>
</Layout>

<style>
    form {
        display: flex;
        flex-direction: column;
        max-width: 300px;
        margin: auto;
    }
    label {
        margin-bottom: 10px;
    }
    input {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        margin-top: 5px;
    }
    button {
        margin-top: 10px;
    }
    p {
        text-align: center;
        margin-top: 50px;
    }

</style>